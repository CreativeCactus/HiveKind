<!DOCTYPE html>
<html><head>
    <meta charset=utf-8 />
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">
    <title>Node map</title>
    <script src="jq.js"></script>
    <script src="cytoscape.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            font: 14px helvetica neue, helvetica, arial, sans-serif;
        }

        #cy {
            height: 100%;
            width: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
    <script>
        var socket = io();
        var MY_ID = Date.now()
        $(function(){ // on dom ready
            $('#cy').cytoscape({
                style: cytoscape.stylesheet()
                .selector('node')
                .css({
                    'width': '60px',
                    'height': '60px',
                    'content': 'data(id)',
                    'pie-size': '80%',
                    'pie-1-background-color': '#E8747C',
                    'pie-1-background-size': 'mapData(foo, 0, 10, 0, 100)'
                    // 'pie-2-background-color': '#74CBE8',
                    // 'pie-2-background-size': 'mapData(bar, 0, 10, 0, 100)',
                    // 'pie-3-background-color': '#74E883',
                    // 'pie-3-background-size': 'mapData(baz, 0, 10, 0, 100)'
                })
                .selector('edge')
                .css({
                    'width': 4,
                    'target-arrow-shape': 'triangle',
                    'opacity': 0.5,
                    'curve-style': 'bezier'
                })
                .selector(':selected')
                .css({
                    'background-color': 'black',
                    'line-color': 'black',
                    'target-arrow-color': 'black',
                    'source-arrow-color': 'black',
                    'opacity': 1
                })
                .selector('.faded')
                .css({
                    'opacity': 0.25,
                    'text-opacity': 0
                }),
                elements: {
                    nodes: [
                    { data: { id: 'a', foo: 3, bar: 5, baz: 2 } },
                    { data: { id: 'b', foo: 6, bar: 1, baz: 3 } },
                    { data: { id: 'e', foo: 2, bar: 3, baz: 5 } }
                    ], 
                    edges: [
                    { data: { id: 'ae', weight: 1, source: 'a', target: 'e' } },
                    { data: { id: 'ab', weight: 3, source: 'a', target: 'b' } }
                    ]
                },
                layout: {
                    name: 'circle',
                    padding: 10
                },
                ready: function(){
                    window.cy = this;
                }
            });
            
            //Despite potential for losing sync with server, 
            //opted for delta events and the inconsistencies will
            // ba handled as errors
            socket.on('addNode', function(msg){ addNode(msg); console.log(`added node ${msg.id}`) });
            socket.on('addEdge', function(msg){ addEdge(msg); console.log(`added edge ${msg.id}`) });
            socket.on('rmvEdge rmvNode', function(msg){ rmvEdge(msg); console.log(`rmved ${msg   }`) });
            socket.emit('hello', {id:MY_ID});

        }); // on dom ready
        
        //Obj is something like 
        //{ id: "x" , foo:3}
        function addNode(obj){
            return cy.add({group:"nodes",data:obj})
        }
        //{ id: "xy", source:'x', target:'y' }
        function addEdge(obj){
            return cy.add({group:"edges",data:obj})
        }
        
        //Selector is something like 
        //'node[name = "Jerry"]'
        //'node#id'
        function rmv(selector){
            cy.rmv(selector)
        }
    </script>
</head><body>
    <div id="cy"></div>
</body></html>